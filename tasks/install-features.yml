---

- name: "Install features: Find the full features install list with versions"
  set_fact:
    full_features_install_list_with_versions: '{% for features in karaf_features %}{{ features.name }}{{ "/" ~ features.version if features.version != "" else "" }} {% endfor %}'
  tags:
    - install-features

- name: "Install features: Find the full features install list without versions"
  set_fact:
    full_features_install_list_without_versions: '{{ full_features_install_list_with_versions | regex_replace("(/\S+)?\s", "|") }}'
  tags:
    - install-features

- name: "Install features: Preparation the full features install list for grep"
  set_fact:
    full_features_install_list_for_grep: "feature:list -i --no-format | grep '^({{ full_features_install_list_without_versions }})\\s'"
  tags:
    - install-features

- name: "Install features: Start Karaf"
  sudo: yes
  service:
    name: '{{ karaf_service_name }}'
    state: started
  tags:
    - install-features

- name: "Install features: Wait for Karaf ssh port"
  wait_for: "port={{ karaf_ssh_port }} timeout=30"
  tags:
    - install-features

- name: "Install features: Apply features configs"
  sudo: yes
  template:
    src: '{{ karaf_path_features_configs }}{{ "/" ~ karaf_environment_configs if karaf_environment_configs is defined else "" }}/{{ item.1 | regex_replace(".*/", "") }}'
    dest: '{{ karaf_home }}/{{ item.1 | regex_replace(".j2", "") }}'
    owner: "{{ karaf_os_user_name }}"
    group: "{{ karaf_os_user_name }}"
    mode: 0644
    backup: yes
  with_subelements:
    - "{{ karaf_features }}"
    - conf_files
  register: karaf_features_configs_changed
  tags:
    - install-features

- name: "Install features: Dump installed features to file"
  sudo: yes
  shell: '{{ karaf_connect_to_local_Karaf_instance }} "{{ full_features_install_list_for_grep }}" >/tmp/feature.txt'
  environment:
    JAVA_HOME: "{{ karaf_java_home }}"
  changed_when: false
  tags:
    - install-features

- name: "Install features: Calculate features diff stage 1"
  replace:
    dest: "/tmp/feature.txt"
    regexp: '(?m)^(\S+)\s+(\S+)(.*)'
    replace: '\1/\2'
  changed_when: false
  tags:
    - install-features

- name: "Install features: Calculate features diff stage 2"
  lineinfile:
    dest: "/tmp/feature.txt"
    regexp: '{{ item.name }}/{{ item.version | regex_replace("-", ".") }}'
    state: absent
  with_items: "{{ karaf_features }}"
  register: karaf_calculate_feature
  changed_when: false
  tags:
    - install-features

- name: "Install features: Get features to upgrade"
  shell: 'cat /tmp/feature.txt'
  register: karaf_features_to_upgrade
  changed_when: false
  tags:
    - install-features

- name: "Install features: Delete feature_Incrementaly.txt"
  file:
    path: '/tmp/feature_Incrementaly.txt'
    state: absent
  changed_when: false
  when: karaf_install_feature_incrementaly
  tags:
    - install-features

- name: "Install features: Calculate features to install Incrementaly"
  lineinfile:
    dest: "/tmp/feature_Incrementaly.txt"
    line: '{{ item.0.name }}/{{ item.0.version }}'
    state: present
    create: yes
  when: karaf_install_feature_incrementaly and item.1 == ""
  with_together:
    - "{{ karaf_features }}"
    - "{{ karaf_calculate_feature.results | map(attribute='msg') | list }}"
  changed_when: false
  tags:
    - install-features

- name: "Install features: Get features to install Incrementaly"
  shell: 'cat /tmp/feature_Incrementaly.txt'
  register: karaf_features_to_incrementaly_instaled
  when: karaf_install_feature_incrementaly
  changed_when: false
  ignore_errors: True
  tags:
    - install-features

- name: "Install features: Check clean cache needed on feature upgrade"
  sudo: yes
  file:
    path: '{{karaf_home }}/data/clean_cache'
    state: touch
    mode: 0755
  register: karaf_cache_cleaned_on_upgrade
  with_items: "{{ karaf_features }}"
  when: (karaf_features_to_upgrade.stdout|search(item.name)
            and item.karaf_clean_cache_on_upgrade is defined
            and item.karaf_clean_cache_on_upgrade == "yes")
            or karaf_clean_cache == "yes"
  tags:
    - install-features

- name: "Install features: Restart Karaf for Clean cache"
  sudo: yes
  service:
    name: '{{ karaf_service_name }}'
    state: restarted
  when: karaf_cache_cleaned_on_upgrade.changed
  tags:
    - install-features

- name: "Install features: Wait for Karaf ssh port"
  wait_for: "port={{ karaf_ssh_port }} timeout=30"
  tags:
    - install-features

- name: "Install features: Set karaf feature install incrementaly list"
  set_fact:
    full_features_install_list_with_versions: "{{ karaf_features_to_incrementaly_instaled.stdout_lines  | join (' ') }}"
  when: (karaf_features_to_incrementaly_instaled.stdout_lines is defined
          and karaf_cache_cleaned_on_upgrade is defined
          and not karaf_cache_cleaned_on_upgrade.changed)
  tags:
    - install-features

- name: "Install features: Add features repositories"
  sudo: yes
  shell: '{{ karaf_connect_to_local_Karaf_instance }} "feature:repo-add {% if item.url|d() %} {{ item.url }} {% else %} {{ item.repo }} {{ item.version }} {% endif %}"'
  sudo_user: "{{ karaf_os_user_name }}"
  environment:
    JAVA_HOME: "{{ karaf_java_home }}"
  with_items: "{{ karaf_features }}"
  when: item.url is defined or item.repo is defined
  changed_when: false
  tags:
    - install-features

- name: "Install features: Perform installation"
  sudo: yes
  shell: '{{ karaf_connect_to_local_Karaf_instance }} "feature:install --upgrade {{ full_features_install_list_with_versions }} ; log:display -n 6 -l INFO org.apache.karaf.features.internal"'
  sudo_user: "{{ karaf_os_user_name }}"
  register: karaf_feature_install
  changed_when: not karaf_feature_install.stdout|search("No deployment change")
  when: full_features_install_list_with_versions != ""
  environment:
    JAVA_HOME: "{{ karaf_java_home }}"
  tags:
    - install-features

- name: "Pause for Install features"
  pause:
    seconds: '5'
  when: karaf_feature_install.changed
  tags:
    - install-features

# TODO не перезапускать только что установленные или обновленные фичи
- name: "Install feature: Restart feature on config change"
  sudo: yes
  shell: '{{ karaf_connect_to_local_Karaf_instance }} "feature:restart {{ item.item[0].name  }}/{{ item.item[0].version }}"'
  sudo_user: "{{ karaf_os_user_name }}"
  environment:
    JAVA_HOME: "{{ karaf_java_home }}"
  when: (item.changed and item.item[0].karaf_on_config_change is defined and item.item[0].karaf_on_config_change == "feature")
  with_items: karaf_features_configs_changed.results
  register: karaf_feature_restarted
  tags:
    - install-features

- name: "Install features: Check Karaf restart needed on feature config change"
  sudo: yes
  action: shell echo "Restart Karaf to changed feature configs"
  when: (item.changed and item.item[0].karaf_on_config_change is defined and item.item[0].karaf_on_config_change == "karaf")
  with_items: karaf_features_configs_changed.results
  register: karaf_restart_on_conf_change_needed
  tags:
    - install-features

- name: "Install feature: Check Karaf restart needed on feature upgrade"
  sudo: yes
  action: shell echo "Restart Karaf"
  with_items: "{{ karaf_features }}"
  when: (karaf_feature_install.changed
          and karaf_features_to_upgrade.stdout != ""
          and karaf_features_to_upgrade.stdout|search(item.name)
          and item.karaf_restart_on_upgrade is defined
          and item.karaf_restart_on_upgrade == "yes")
  register: karaf_restart_on_feature_upgrade_needed
  tags:
    - install-features

- name: "Install features: Restart Karaf on feature upgrade or config change"
  sudo: yes
  service:
    name: '{{ karaf_service_name }}'
    state: restarted
  when: karaf_restart_on_conf_change_needed.changed or karaf_restart_on_feature_upgrade_needed.changed
  register: karaf_restart_on_feature_upgrade
  tags:
    - install-features

- name: "Install features: Wait for Karaf ssh port"
  wait_for: "port={{ karaf_ssh_port }} timeout=30"
  tags:
    - install-features

- name: "Install features: Check OSGI services is running"
  sudo: yes
  shell: '{{ karaf_connect_to_local_Karaf_instance }} "service:wait -e -t {{ karaf_timeout_to_wait_service }} {{ item.wait_service }}"'
  sudo_user: "{{ karaf_os_user_name }}"
  environment:
    JAVA_HOME: "{{ karaf_java_home }}"
  when: '{{ item.wait_service is defined and (karaf_feature_install.changed or karaf_restart_on_feature_upgrade.changed or karaf_feature_restarted.changed or karaf_features_configs_changed.changed)}}'
  with_items: "{{ karaf_features }}"
  tags:
    - install-features
